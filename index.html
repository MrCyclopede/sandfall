<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sandfall</title>
    <style></style>
</head>

<body style="overflow:hidden; margin:0">

    <canvas id="gameCanvas" style="border:10px;  solid #FFF555; " ></canvas>
    <script>

        var canvas, context;

        canvas = document.getElementById("gameCanvas");
        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;
        context = canvas.getContext("2d");

        function blackout_screen(){
          context.fillStyle = '000000';
          context.fillRect( 0, 0, canvas.width, canvas.height);
        }

        var mouse_down = false
        var mouse_pos = []
        const FPS = 100;


        //GAME
        var ELEMENT_SIZE = 10
        var elements = []

        // - MAP
        function create_map(h, w) {
          var map = [];
          for (let i = 0; i < h; i++) {
              map.push( new Array(w).fill(0));
          }
          return map;
        }
        var map_h = Math.round(window.innerHeight / ELEMENT_SIZE)
        var map_w = Math.round(window.innerWidth / ELEMENT_SIZE)
        console.log("Map size: [y:", map_h,"] [x:", map_w, "]", window.innerHeight,"x", window.innerWidth)
        var map = create_map(map_h, map_w)

        // - ELEMENTS
        var AIR = 0
        function move_element(elem, from, to){

          map[from[1]][from[0]] = 0
          draw_air(from[0], from[1])

          map[to[1]][to[0]] = elem.code
          elem.x = to[0]
          elem.y = to[1]
          draw_elem(elem)
        }


        function draw_air(x, y){
          context.fillStyle = '#000000';
          context.fillRect( x * ELEMENT_SIZE, y * ELEMENT_SIZE, ELEMENT_SIZE, ELEMENT_SIZE);
        }

        var SAND = 1
        class Sand {
          constructor(x, y) {
            this.x = x
            this.y = y
            this.color = "#FFF4C0"
            this.code = 1
          }

          fall() {
            if (this.y + 1 >= map_h){
              return
            }
            else if (map[this.y + 1][this.x] == AIR){
              move_element(this, [this.x, this.y], [this.x, this.y + 1])
            }
            else if (map[this.y + 1][this.x - 1] == AIR && this.x >= 1){
              move_element(this, [this.x, this.y], [this.x - 1, this.y + 1])
            }
            else if (map[this.y + 1][this.x + 1] == AIR && this.x <= map_w){
              move_element(this, [this.x, this.y], [this.x + 1, this.y + 1])
            }
          }
        }

        // var elem_classes =


        function update_elements(){
          if (mouse_pos.length > 0 && mouse_down == true){
            spawn_elem(mouse_pos[0], mouse_pos[1], SAND)
          }
          elements.forEach((elem) => {
            elem.fall()
          });
        }

        function draw_elem(elem){
          context.fillStyle = elem.color;
          context.fillRect(elem.x * ELEMENT_SIZE, elem.y * ELEMENT_SIZE, ELEMENT_SIZE, ELEMENT_SIZE);
        }

        function spawn_elem(x, y, elem){

          if (map[y][x] != 0){return}
          let new_elem = new Sand(x, y)
          map[y][x] = new_elem.code
          draw_elem(new_elem)
          elements.push(new_elem)
        }


        // - GAME START
        blackout_screen()
        setInterval(update_elements, 1000 / FPS)


        // EVENT LISTENERS
        document.addEventListener('mousemove', function(event){
            if (mouse_down == true){
              let x = Math.round(event.clientX / ELEMENT_SIZE)
              let y = Math.round(event.clientY / ELEMENT_SIZE)
              mouse_pos[0] = x
              mouse_pos[1] = y
              spawn_elem(x, y, SAND)
            }
        }, true);

        document.addEventListener('mousedown', function(event){
            let x = Math.round(event.clientX / ELEMENT_SIZE)
            let y = Math.round(event.clientY / ELEMENT_SIZE)
            mouse_pos[0] = x
            mouse_pos[1] = y
            mouse_down = true
        }, true);

        document.addEventListener('mouseup', function(event){
            mouse_down = false
        }, true);

        document.addEventListener('click', function(event){
            let x = Math.round(event.clientX / ELEMENT_SIZE)
            let y = Math.round(event.clientY / ELEMENT_SIZE)
            spawn_elem(x, y, SAND)
        }, true);

        document.addEventListener('keydown', function(event){
          if (event.keyCode == 38) {
           //up

          }
          else if (event.keyCode == 40) {
              //down
            update_elements()
          }
        }, true);

    </script>
</body>
</html>
